---
title: "BEE 4750 Homework 3: Dissolved Oxygen"
format:
    html:        
        warning: true
        error: true
    ipynb:
        warning: true
        error: true
        code-annotation: below
jupyter: julia-1.9
format-links: []
---

::: {.content-visible when-format="ipynb"}
**Name**:

**ID**:
:::

::: {.callout-important icon=false}
### Due Date

Friday, 10/06/23, 9:00pm
:::

::: {.content-visible when-format="html"}

:::{.callout-caution}

If you are enrolled in the course, make sure that you use the GitHub Classroom link provided in Ed Discussion, or you may not be able to get help if you run into problems.

Otherwise, you can [find the Github repository here]({{< var github_org.repo >}}/hw03).

:::

:::

## Overview

### Instructions

- Problems 1-3 consist of a series of code snippets for you to interpret and debug. For Problems 1 and 2, you will be asked to identify relevant error(s) and fix the code. For Problem 3, the code works as intended; your goal is to identify the code's purpose by following its logic.
- Problem 4 asks you to convert a verbal description of a wastewater treatment system into a Julia function, and then to use that function to explore the impact of different wastewater allocation strategies.

### Load Environment

The following code loads the environment and makes sure all needed packages are installed. This should be at the start of most Julia scripts.

```{julia}
#| output: false
import Pkg
Pkg.activate(@__DIR__)
Pkg.instantiate()
```

```{julia}
using Plots
using LaTeXStrings
using Distributions
```

## Problems (Total: 100 Points)

::: {.cell .markdown}
### Problem 1 (60 points)

A river which flows at 6 km/d is receiving waste discharges from two sources which are 15 km apart, as shown in @fig-river. The oxygen reaeration rate is 0.55 day^-1^, and the decay rates of CBOD and NBOD are are 0.55 and 0.25 day^-1^, respectively. The river's saturated dissolved oxygen concentration is 10m g/L.

![Schematic of the system in Problem 1](figures/river_diagram.png){#fig-river}

:::

::: {.cell .markdown}

#### Problem 1.1 (20 points)

If the characteristics of the river inflow and waste discharges are given in @tbl-river, plot the dissolved oxygen concentration in the river from the first waste stream to 50km downstream.

| Parameter | River Inflow | Waste Stream 1 | Waste Stream 2 |
|:---------:|-------------:|---------------:|---------------:|
| Inflow | 100,000 m^3^/d | 10,000 m^3^/d | 15,000 m^3^/d |
| DO Concentration | 7.5 mg/L | 5 mg/L | 5 mg/L |
| CBOD | 5 mg/L | 50 mg/L | 45 mg/L |
| NBOD | 5 mg/L | 35 mg/L | 35 mg/L |
: River inflow and waste stream characteristics for Problem 1. {#tbl-river}

:::

::: {.cell .markdown}
#### Problem 1.2 (10 points)

Under the assumptions of Problem 1.1, determine the distance from waste stream 2 it will take for the dissolved oxygen concentration of the river to recover to 6 mg/L.
:::

::: {.cell .markdown}
#### Problem 1.3 (10 points)

What is the minimum level of treatment (% removal of organic waste) for waste stream 2 that will ensure that the dissolved oxygen concentration never drops below 4 mg/L, assuming that waste stream 1 remains untreated?
:::

::: {.cell .markdown}
#### Problem 1.4 (10 points)

If both waste streams are treated equally, what is the minimum level of treatment (% removal of organic waste) for the two sources required to ensure that the dissolved oxygen concentration never drops below 4 mg/L?

:::

::: {.cell .markdown}

#### Problem 1.5 (10 points)

Suppose you are responsible for designing a waste treatment plan for discharges into the river, with a regulatory mandate to keep the dissolved oxygen concentration above 4 mg/L. Discuss whether you'd opt to treat waste stream 2 alone or both waste streams equally. What other information might you need to make a conclusion, if any?

:::

::: {.cell .markdown}
### Problem 2 (40 points)
:::

::: {.cell .markdown}
#### Problem 2.1 (15 points)

Suppose now that the CBOD and NBOD values of the river inflow are uncertain. Suppose that your estimates of CBOD vary uniformly between 4 mg/L and 7 mg/L, and NBOD estimates vary uniformly between 3 mg/L and 8 mg/L. 

If you assume these values are independent, what is the probability that the strategy you selected in Problem 1.5 will fail to keep the dissolved oxygen concentration above 4 mg/L? How did you decide how many samples to use to determine this probability?
:::

::: {.cell .markdown}
#### Problem 2.2 (15 points)

Now suppose that CBOD and NBOD values are correlated: specifically, they have a correlation coefficient of 0.7. How does that impact the probability of maintaining a dissolved oxygen concentration above 4 mg/L under the treatment strategy you selected in Problem 1.5? How did you decide how many samples to use to determine this probability?

You can use the `sample_correlated_uniform()` function defined below to produce correlated uniform samples. 
:::

```{julia}
#| echo: true

# This function samples n correlated variates distributed over 
# Uniform(a[1], a[2]) and Uniform(b[1], b[2]) with correlation coefficient
# corr_coef. The bounds on each uniform distribution should be passed as a vector
# or a tuple.
function sample_correlated_uniform(n, a, b, corr_coef=0.7)
    # set up a multivariate normal with each marginal variance of 1 
    # and the right correlation
    mvnorm = MvNormal([0, 0], PDMat([1 corr_coef; corr_coef 1])) 
    # sample from the multivariate normal, the marginal distributions 
    # are a standard normal
    norm_samples = rand(mvnorm, n)' 
    # convert samples to a uniform distribution using the pdf of a standard Normal
    unif_samples = cdf.(Normal(0, 1), norm_samples) 
    # transform the samples to have the right range
    samples = (unif_samples .* [a[2] - a[1] b[2] - b[1]]) .+ [a[1] b[1]]
    return samples
end
```

::: {.cell .markdown}
#### Problem 2.3 (10 points)

Discuss how the presence of uncertainty and dependence between variables might affect your decision-making process. Does the impact of the correlation between the CBOD and NBOD inputs in Problem 2.2 make sense to you? Would you stick with the same strategy as Problem 1.5? What other information might you need to make this assessment, if any? 
:::

::: {.cell .markdown}
## References

List any external references consulted, including classmates.
:::